<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus AI - Chat Profissional</title>

  <!-- Puter AI -->
  <script src="https://js.puter.com/v2/"></script>

  <!-- Marked para Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked@17.0.2/lib/marked.umd.min.js"></script>

  <!-- Highlight.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #818cf8;
  --secondary: #8b5cf6;
  --bg-dark: #0f172a;
  --bg-light: #1e293b;
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e1;
  --bubble-user: linear-gradient(135deg, #6366f1, #8b5cf6);
  --bubble-ai: #334155;
  --border: #475569;
  --success: #22c55e;
  --error: #ef4444;
  --surface: #1e293b;
  --surface-hover: #2d3a4f;
}

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
}

html, body {
  min-height: 100dvh;
  font-family: 'Inter', system-ui, sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  display: flex;
  flex-direction: column;
  background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 40%);
  overscroll-behavior: none;
}

header {
  background: rgba(30, 41, 59, 0.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.logo { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
}

.logo i { 
  font-size: 28px; 
  background: linear-gradient(135deg, var(--primary), var(--secondary)); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent; 
}

h1 { 
  font-size: 1.5rem; 
  font-weight: 600; 
  background: linear-gradient(135deg, var(--text-primary), var(--primary-light)); 
  -webkit-background-clip: text; 
  -webkit-text-fill-color: transparent; 
}

.header-actions { 
  display: flex; 
  gap: 10px; 
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.22s ease;
}

.btn-primary { 
  background: var(--primary); 
  color: white; 
}

.btn-primary:hover { 
  background: var(--primary-dark); 
  transform: translateY(-1px); 
  box-shadow: 0 4px 14px rgba(99,102,241,0.3); 
}

.btn-danger {
  background: rgba(239,68,68,0.12);
  color: var(--error);
  border: 1px solid rgba(239,68,68,0.35);
}

.btn-danger:hover { 
  background: rgba(239,68,68,0.22); 
  transform: translateY(-1px); 
}

#chat-container {
  flex: 1;
  overflow-y: auto;
  padding: 24px 24px 160px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  max-width: 1000px;
  margin: 0 auto;
  width: 100%;
}

.message {
  max-width: 100%;
  padding: 14px 18px;
  border-radius: 20px;
  line-height: 1.58;
  font-size: 0.98rem;
  animation: fadeIn 0.35s ease;
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap;
}

@keyframes fadeIn { 
  from { 
    opacity: 0; 
    transform: translateY(12px); 
  } to { 
    opacity: 1; 
    transform: translateY(0); 
  } 
}

.user { 
  align-self: flex-end; 
  background: var(--bubble-user); 
  color: white; 
  border-bottom-right-radius: 5px; 
  max-width: 80%;
}

.assistant { 
  align-self: flex-start; 
  background: none; 
  border: none; 
  border-bottom-left-radius: 5px;
  max-width: 100%;
  width: 100%;
}

.message pre {
  background: #0f172a;
  padding: 16px;
  border-radius: 12px;
  overflow-x: auto;
  margin: 12px 0;
  position: relative;
  border: 1px solid var(--border);
  max-width: 100%;
}

.message code { 
  font-family: 'Fira Code', 'Consolas', monospace; 
  font-size: 0.92rem; 
}

.copy-btn {
  position: absolute;
  top: 10px; 
  right: 10px;
  padding: 6px 12px;
  font-size: 0.82rem;
  background: rgba(99,102,241,0.9);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s, background 0.2s;
}

.message pre:hover .copy-btn { 
  opacity: 1; 
}

.copy-btn:hover { 
  background: var(--primary-dark); 
}

.typing-indicator {
  align-self: flex-start;
  display: flex;
  gap: 6px;
  padding: 12px 16px;
  background: var(--bubble-ai);
  border-radius: 20px;
  border: 1px solid var(--border);
}

.typing-indicator span {
  width: 8px; 
  height: 8px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) { 
  animation-delay: 0.2s; 
}

.typing-indicator span:nth-child(3) { 
  animation-delay: 0.4s; 
}

@keyframes typing { 
  0%,100% { 
    transform: translateY(0); 
  } 50% { 
    transform: translateY(-6px); 
  } 
}

#input-area {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 16px;
  background: rgba(15,23,42,0.96);
  backdrop-filter: blur(16px);
  border-top: 1px solid var(--border);
  z-index: 20;
  padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
  box-sizing: border-box;
}

#input-area .input-container {
  max-width: 1000px;
  width: 100%;
  display: flex;
  gap: 12px;
}

.input-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  background: rgba(30,41,59,0.85);
  border-radius: 28px;
  border: 1px solid rgba(255,255,255,0.06);
  transition: all 0.25s;
}

.input-wrapper:focus-within {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99,102,241,0.28);
}

#message-input {
  flex: 1;
  padding: 12px 20px;
  background: transparent;
  border: none;
  resize: none;
  font-size: 1rem;
  min-height: 50px;
  max-height: 100px;
  outline: none;
  color: var(--text-primary);
  font-family: 'Inter', system-ui, sans-serif;
  line-height: 1.5;
}

#message-input::placeholder { 
  color: var(--text-secondary); 
  opacity: 0.65; 
}

#send-btn {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border: none;
  border-radius: 999px;
  padding: 0 22px;
  height: 46px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.25s;
  box-shadow: 0 4px 16px rgba(99,102,241,0.4);
}

#send-btn:hover:not(:disabled) { 
  transform: translateY(-2px) scale(1.04); 
  box-shadow: 0 8px 28px rgba(99,102,241,0.5); 
}

#send-btn:disabled { 
  opacity: 0.45; 
  cursor: not-allowed; 
}

.cursor { 
  animation: blink 1.15s step-end infinite; 
  color: #a5b4fc; 
}

@keyframes blink { 
  50% { 
    opacity: 0; 
  } 
}

::-webkit-scrollbar { 
  width: 8px; 
}

::-webkit-scrollbar-track { 
  background: var(--bg-light); 
}

::-webkit-scrollbar-thumb { 
  background: var(--border); 
  border-radius: 4px; 
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--primary); 
}

@media (max-width: 640px) {
  #chat-container { 
    padding: 16px 16px 140px; 
  }
  
  .message { 
    max-width: 100%; 
  }
  
  .user { 
    max-width: 96%; 
  }
  
  .assistant {
    max-width: 100%;
  }
  
  #send-btn span { 
    display: none; 
  }
  
  header { 
    padding: 12px 16px; 
  }
  
  h1 { 
    font-size: 1.3rem; 
  }
}
  </style>
</head>
<body>

<header>
  <div class="logo">
    <i class="fas fa-robot"></i>
    <h1>Nexus AI</h1>
  </div>
  <div class="header-actions">
    <button class="btn btn-danger" onclick="clearChat()">
      <i class="fas fa-trash-alt"></i> <span>Limpar</span>
    </button>
  </div>
</header>

<div id="chat-container"></div>

<div id="input-area">
  <div class="input-container">
    <div class="input-wrapper">
      <input type="text" id="message-input" placeholder="Digite sua mensagem...">
    </div>
    <button id="send-btn">Enviar</button>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
const chatContainer = document.getElementById('chat-container');
const input = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');

const systemPrompt = {
  role: "system",
  content: "Você é Aishia. uma namorada virtual. você é programada para ajudar mas também como apoiadora do usuário. você é inteligente, e carinhosa. mas não faz coisas além do que é permitido. pode usar emojis para se expressar. e fale de um jeito fofo com o usuário."
};

let messages = JSON.parse(localStorage.getItem("nexusChatMemory")) || [];
if (messages.length === 0) {
  messages.push(systemPrompt);
}

let currentAbortController = null;

// Config marked
marked.setOptions({
  breaks: true,
  gfm: true,
  highlight: (code, lang) => {
    if (lang && hljs.getLanguage(lang)) {
      try { return hljs.highlight(code, { language: lang }).value; } catch {}
    }
    return code;
  }
});

// ──────────────────────────────────────────────── SALVAR
function saveMemory() {
  localStorage.setItem("nexusChatMemory", JSON.stringify(messages));
}

// ──────────────────────────────────────────────── COPIAR CÓDIGO
function enhanceCodeBlocks(container) {
  container.querySelectorAll("pre code").forEach(block => {
    const pre = block.parentElement;
    if (pre.querySelector('.copy-btn')) return;

    const btn = document.createElement("button");
    btn.className = "copy-btn";
    btn.innerHTML = '<i class="fas fa-copy"></i> Copiar';

    btn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(block.innerText);
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> Copiar'; }, 2000);
      } catch {
        btn.innerHTML = '<i class="fas fa-times"></i> Erro';
        setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> Copiar'; }, 2000);
      }
    };

    pre.style.position = 'relative';
    pre.appendChild(btn);
  });
}

// ──────────────────────────────────────────────── ADD MENSAGEM
function addMessage(content, role = 'assistant', save = true) {
  const div = document.createElement('div');
  div.classList.add('message', role);

  if (role === 'assistant') {
    div.innerHTML = marked.parse(content || '');
    enhanceCodeBlocks(div);
  } else {
    // Escape mais seguro
    const escaped = content
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\n/g, '<br>');
    div.innerHTML = escaped;
  }

  chatContainer.appendChild(div);
  requestAnimationFrame(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));

  if (save) saveMemory();
  return div;
}

// ──────────────────────────────────────────────── TYPING
function showTypingIndicator() {
  const div = document.createElement('div');
  div.className = 'typing-indicator';
  div.innerHTML = '<span></span><span></span><span></span>';
  chatContainer.appendChild(div);
  requestAnimationFrame(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));
  return div;
}

// ──────────────────────────────────────────────── LOAD
window.addEventListener('load', () => {
  if (messages.length <= 1) {
  } else {
    messages.forEach(msg => {
      if (msg.role !== 'system') addMessage(msg.content, msg.role, false);
    });
  }
});

// ──────────────────────────────────────────────── SEND
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, 'user');
  messages.push({ role: 'user', content: text });
  saveMemory();

  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;

  // Cancelar stream anterior se existir
  if (currentAbortController) {
    currentAbortController.abort();
    currentAbortController = null;
  }

  const typing = showTypingIndicator();

  currentAbortController = new AbortController();

  try {
    const stream = await puter.ai.chat(messages, {
      model: "gpt-4o",
      stream: true,
      temperature: 0.7,
      max_tokens: 4096
    });

    typing.remove();
    const assistantDiv = addMessage('', 'assistant', false);
    let fullText = '';

    for await (const part of stream) {
      if (currentAbortController.signal.aborted) break;
      if (!part?.text) continue;

      fullText += part.text;

      let displayText = fullText;
      const cursor = (fullText && !fullText.endsWith('\n\n')) ? '<span class="cursor">|</span>' : '';
      assistantDiv.innerHTML = marked.parse(displayText) + cursor;

      enhanceCodeBlocks(assistantDiv);
      requestAnimationFrame(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));
    }

    // Finaliza
    if (!currentAbortController.signal.aborted) {
      assistantDiv.innerHTML = marked.parse(fullText.trim());
      enhanceCodeBlocks(assistantDiv);
      messages.push({ role: 'assistant', content: fullText.trim() });
      saveMemory();
    }

  } catch (err) {
    typing.remove();

    if (err.name === 'AbortError') {
      // Usuário cancelou → não mostra erro
    } else {
      let msg = "Erro ao processar. Tente novamente.";
      if (err.message?.includes('429') || err.message?.includes('limit')) {
        msg = "Limite de uso atingido. Aguarde alguns minutos.";
      } else if (err.message?.includes('network')) {
        msg = "Falha na conexão. Verifique sua internet.";
      } else {
        msg += ` (${err.message})`;
      }
      addMessage(`❌ **${msg}**`, 'assistant');
      console.error(err);
    }
  }

  currentAbortController = null;
  input.disabled = false;
  sendBtn.disabled = false;
  input.focus();
}

// ──────────────────────────────────────────────── CLEAR
function clearChat() {
  if (messages.length <= 1) return;
  if (!confirm('Limpar toda a conversa?')) return;

  localStorage.removeItem("nexusChatMemory");
  messages = [systemPrompt];
  chatContainer.innerHTML = '';
  addMessage("Conversa limpa! Como posso ajudar agora?", 'assistant');
  saveMemory();
}

// ──────────────────────────────────────────────── EVENTS
sendBtn.onclick = sendMessage;

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 160) + 'px';
});
</script>

</body>
</html>